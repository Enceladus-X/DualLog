interface Match {
  yourDeck: string
  opponentDeck: string
  position: "first" | "second"
  result: "win" | "lose"
  timestamp: string
  winStreak: number
  note?: string
}

export function generateTodayReportImage(matches: Match[], t: any): Promise<string> {
  return new Promise((resolve) => {
    const canvas = document.createElement("canvas")
    const ctx = canvas.getContext("2d")!

    // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (Instagram ì •ì‚¬ê°í˜• ë¹„ìœ¨)
    canvas.width = 800
    canvas.height = 800

    // ë°°ê²½ìƒ‰ ì„¤ì •
    ctx.fillStyle = "#f8fafc"
    ctx.fillRect(0, 0, canvas.width, canvas.height)

    // í—¤ë” ê·¸ë¦¬ê¸°
    const headerHeight = 120
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, headerHeight)
    gradient.addColorStop(0, "#3b82f6")
    gradient.addColorStop(1, "#1d4ed8")

    ctx.fillStyle = gradient
    ctx.fillRect(0, 0, canvas.width, headerHeight)

    // í—¤ë” í…ìŠ¤íŠ¸
    ctx.fillStyle = "white"
    ctx.font = "bold 32px Arial, sans-serif"
    ctx.textAlign = "center"
    ctx.fillText("ğŸ® Omegagu Report", canvas.width / 2, 45)

    const today = new Date().toLocaleDateString("ko-KR", {
      year: "numeric",
      month: "long",
      day: "numeric",
    })
    ctx.font = "20px Arial, sans-serif"
    ctx.fillText(`${today} ì „ì `, canvas.width / 2, 80)

    // ê²Œì„ ë¦¬ìŠ¤íŠ¸ ì˜ì—­
    let yPos = headerHeight + 40
    const gameHeight = 60
    const maxGames = Math.min(matches.length, 8) // ìµœëŒ€ 8ê²Œì„ë§Œ í‘œì‹œ

    matches.slice(0, maxGames).forEach((match, index) => {
      // ê²Œì„ ì¹´ë“œ ë°°ê²½
      const cardColor = match.result === "win" ? "#dcfce7" : "#fef2f2"
      const borderColor = match.result === "win" ? "#16a34a" : "#dc2626"

      ctx.fillStyle = cardColor
      ctx.fillRect(40, yPos, canvas.width - 80, gameHeight - 10)

      // í…Œë‘ë¦¬
      ctx.strokeStyle = borderColor
      ctx.lineWidth = 2
      ctx.strokeRect(40, yPos, canvas.width - 80, gameHeight - 10)

      // ê²°ê³¼ ì•„ì´ì½˜
      const icon = match.result === "win" ? "ğŸŸ¢" : "ğŸ”´"
      const resultIcon = match.result === "win" ? "âœ…" : "âŒ"

      ctx.fillStyle = "#1f2937"
      ctx.font = "18px Arial, sans-serif"
      ctx.textAlign = "left"

      // ê²Œì„ ì •ë³´ í…ìŠ¤íŠ¸
      const positionText = match.position === "first" ? "ì„ ê³µ" : "í›„ê³µ"
      const gameText = `${icon} ${match.yourDeck} vs ${match.opponentDeck} (${positionText}) ${resultIcon}`

      ctx.fillText(gameText, 60, yPos + 30)

      // ì—°ìŠ¹ í‘œì‹œ
      if (match.winStreak > 1) {
        ctx.fillStyle = "#16a34a"
        ctx.font = "bold 14px Arial, sans-serif"
        ctx.textAlign = "right"
        ctx.fillText(`${match.winStreak}ì—°ìŠ¹!`, canvas.width - 60, yPos + 30)
      }

      yPos += gameHeight
    })

    // ë” ë§ì€ ê²Œì„ì´ ìˆì„ ê²½ìš° í‘œì‹œ
    if (matches.length > maxGames) {
      ctx.fillStyle = "#6b7280"
      ctx.font = "16px Arial, sans-serif"
      ctx.textAlign = "center"
      ctx.fillText(`... ì™¸ ${matches.length - maxGames}ê²Œì„ ë”`, canvas.width / 2, yPos + 20)
      yPos += 40
    }

    // í†µê³„ ì˜ì—­
    const statsY = Math.max(yPos + 40, canvas.height - 180)

    // í†µê³„ ë°°ê²½
    ctx.fillStyle = "#f1f5f9"
    ctx.fillRect(40, statsY, canvas.width - 80, 120)
    ctx.strokeStyle = "#cbd5e1"
    ctx.lineWidth = 1
    ctx.strokeRect(40, statsY, canvas.width - 80, 120)

    // í†µê³„ ê³„ì‚°
    const wins = matches.filter((m) => m.result === "win").length
    const winRate = matches.length > 0 ? ((wins / matches.length) * 100).toFixed(1) : "0.0"
    const maxStreak = Math.max(...matches.map((m) => m.winStreak), 0)

    // í†µê³„ í…ìŠ¤íŠ¸
    ctx.fillStyle = "#1f2937"
    ctx.font = "bold 24px Arial, sans-serif"
    ctx.textAlign = "center"
    ctx.fillText(`ğŸ“Š ${matches.length}ê²Œì„ | ìŠ¹ë¥  ${winRate}%`, canvas.width / 2, statsY + 40)

    if (maxStreak > 1) {
      ctx.font = "bold 20px Arial, sans-serif"
      ctx.fillStyle = "#dc2626"
      ctx.fillText(`ğŸ”¥ ${maxStreak}ì—°ìŠ¹ ë‹¬ì„±!`, canvas.width / 2, statsY + 75)
    }

    // ì›Œí„°ë§ˆí¬
    ctx.fillStyle = "#9ca3af"
    ctx.font = "14px Arial, sans-serif"
    ctx.textAlign = "center"
    ctx.fillText("Generated by Omegagu", canvas.width / 2, canvas.height - 20)

    // ì´ë¯¸ì§€ ë°ì´í„° URL ë°˜í™˜
    resolve(canvas.toDataURL("image/png"))
  })
}

export function downloadImage(dataUrl: string, filename: string) {
  const link = document.createElement("a")
  link.download = filename
  link.href = dataUrl
  link.click()
}

export async function copyImageToClipboard(dataUrl: string) {
  try {
    const response = await fetch(dataUrl)
    const blob = await response.blob()
    await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })])
    return true
  } catch (error) {
    console.error("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", error)
    return false
  }
}
